{% extends 'base.html' %}
{% block register %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            <img src="{{ product.ImageURL }}" class="img-fluid" alt="{{ product.name }}">
        </div>
        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <p><strong>Giá:</strong> {{ product.price|floatformat:0 }} VNĐ</p>
            <p><strong>Mô tả:</strong> {{ product.description }}</p>

            <!-- Số lượng có nút +/- -->
            <div class="mb-3">
                <label for="quantity"><strong>Số lượng:</strong></label>
                <div class="input-group" style="max-width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" onclick="decrement()">-</button>
                    <input type="number" id="quantity" class="form-control text-center" value="1" min="1">
                    <button class="btn btn-outline-secondary" type="button" onclick="increment()">+</button>
                </div>
            </div>

            <!-- Lời nhắn -->
            <div class="mb-3">
                <label for="order-note"><strong>Lời nhắn đến cửa hàng:</strong></label>
                <textarea id="order-note" name="order-note" rows="3"
                          class="form-control border border-danger rounded-4"
                          placeholder="Thêm lời nhắn đến cửa hàng"></textarea>
            </div>

            <!-- Nút thêm vào giỏ hàng -->
            <button data-product="{{ product.id }}" data-action="add"
                    class="btn btn-outline-primary update-cart">
                Thêm vào giỏ hàng
            </button>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    function increment() {
        var input = document.getElementById('quantity');
        var current = parseInt(input.value) || 1;
        input.value = current + 1;
    }

    function decrement() {
        var input = document.getElementById('quantity');
        var current = parseInt(input.value) || 1;
        if (current > 1) input.value = current - 1;
    }

    const updateBtns = document.getElementsByClassName('update-cart');

    for (let i = 0; i < updateBtns.length; i++) {
        updateBtns[i].addEventListener('click', function () {
            const productID = this.dataset.product;
            const action = this.dataset.action;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const note = document.getElementById('order-note').value || "";

            if (user === "AnonymousUser") {
                alert("Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng.");
            } else {
                updateUserOrder(productID, action, quantity, note);
            }
        });
    }

    function updateUserOrder(productID, action, quantity, note) {
        const url = '/update_item/';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                productID: productID,
                action: action,
                quantity: quantity,
                note: note
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Giỏ hàng cập nhật:', data);
            location.reload(); // Cập nhật lại trang để hiện số lượng mới
        });
    }
</script>
{% endblock %}
